<html>
  <head>
    <title>Upload to S3</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <style>
      body {
        font-family: 'Verdana', Verdana, sans-serif;
      }
      .aligner {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      #drop {
        height: 100px;
        width: 300px;
        border-radius: 300px;
        color: #FFFFFF;
        background-color: #000c93;
        font-size: 20px;
        display: flex;
        align-items: center;
      }
    </style>
  </head>

  <body>

    <div class="aligner">
      Loaded file: <a id='audioFile' href=""></a><br>
      <audio controls>
        <source id='audioURL' type="audio/mp3" src=""></source>
      </audio>
      <form name="audioForm">
        Enter Access Key:<br>
        <input type="text" name="AccessKey"><br>
        <input type="submit" value="Submit">
      </form>

      <div id="drop">Drop mp3 file here.</div>
      <div id="list">
        <h1>Access Keys:</h1>
      </div>
    <div>
      
    

    <script type="text/javascript">
      var apiBaseURL = "https://tdyubs8tnh.execute-api.us-east-1.amazonaws.com/dev"
      var drop = document.getElementById('drop');
      var list = document.getElementById('list');
      // var submit = document.getElementById('submit');
      var accessKey = getURLVars()["AccessKey"];

      function cancel(e) {
        e.preventDefault();
        return false;
      }

      function getURLVars() {
        var vars = {};
        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
            vars[key] = value;
        });
        return vars;
      }

      function handleDrop(e) {
        e.preventDefault();
        var dt    = e.dataTransfer;
        var files = dt.files;
        for (var i=0; i<files.length; i++) {
          var file = files[i];
          var timestamp = "";
          var key = file.name.split(" ").join("");
          var reader = new FileReader();
          reader.addEventListener('loadend', function(e) {
            fetch(apiBaseURL+"/getURL", {
              method: "POST",
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                name: file.name,
                type: file.type
              })
            })
            .then(function(response) {
              return response.json();
            })
            .then(function(json) {
              timestamp = "" + json.timestamp;
              key = timestamp + "_" + key;
              console.log(timestamp);
              return fetch(json.uploadURL, {
                method: "PUT",
                body: new Blob([reader.result], {key: json.key, type: file.type})
              })
            })
            .then(function() {
              var uploadedFileNode = document.createElement('div');
              var url = window.location.origin + window.location.pathname;
              uploadedFileNode.innerHTML = '<a href="'+ url + "?AccessKey=" + key +'">'+ key +'</a>';
              list.appendChild(uploadedFileNode);
            });
          });
          reader.readAsArrayBuffer(file);
        }
        return false;
      }

      function handleKey() {
        
        // fetch(apiBaseURL+"/getFileURL", {
        //   method: "POST",
        //   headers: {
        //     'Content-Type': 'application/json',
        //   },
        //   body: JSON.stringify({
        //     key: accessKey,
        //   })
        // })
        // .then(function(response) {
        //   return response.json();
        // })
        // .then(function(json) {
        //   if (json.url != "undefined")
        //     document.getElementById('audioURL').src = json.url;
        // });
        var url = "https://s3.amazonaws.com/audemos-dev-demos/" + accessKey;
        document.getElementById('audioURL').src = url;
        document.getElementById('audioFile').href = url;
      }

      // <audio controls preload="metadata" style=" width:300px;">
      //   <source src="" type="audio/mpeg">
      //   Your browser does not support the audio element.
      // </audio><br />
      // // <audio controls="controls">
      // //   <source src="" type="audio/mpeg" >
      // // </audio><br />

      // Tells the browser that we *can* drop on this target
      drop.addEventListener('dragenter', cancel);
      drop.addEventListener('dragover', cancel);
      drop.addEventListener('drop', handleDrop);

      console.log(accessKey);
      if (accessKey != null) {
        handleKey();
      }
    </script>

  </body>
</html>
