<html>
  <head>
    <title>Upload to S3</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <style>
      body {
        font-family: 'Verdana', Verdana, sans-serif;
      }
      .aligner {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      #drop {
        height: 100px;
        width: 300px;
        border-radius: 300px;
        color: #FFFFFF;
        background-color: #000c93;
        font-size: 20px;
        display: flex;
        align-items: center;
      }
      .header_1{
        border: 1px solid powderblue;
        margin: 50px;
        align-items: center;
        justify-content: center;
      }
    </style>
  </head>

  <body>

    <div class="aligner">
      <b>Loaded file:</b> <p id='audioFile'></p>
      <audio controls>
        <source id='audioURL' type="audio/mp3" src=""></source>
      </audio>
      <form name="audioForm">
        <b>Enter Access Key:</b><br>
        <input type="text" name="AccessKey">
        <input type="submit" value="Submit">
      </form>

      <div class="header_1" id="drop">Drop mp3 file here.</div>
      <button onclick="copyURL()">Copy Latest URL</button>
      <button onclick="copyKey()">Copy Latest Key</button>
      <div id="list">
        <h1>Access Keys:</h1>
      </div>
    </div>
      
    

    <script type="text/javascript">
      var apiBaseURL = "https://tdyubs8tnh.execute-api.us-east-1.amazonaws.com/dev"
      var drop = document.getElementById('drop');
      var list = document.getElementById('list');
      var accessKey = getURLVars()["AccessKey"];

      function cancel(e) {
        e.preventDefault();
        return false;
      }

      // Get the variables stored in our URL.
      function getURLVars() {
        var vars = {};
        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
            vars[key] = value;
        });
        return vars;
      }

      // Handle when the user drops a file into the dropzone
      function handleDrop(e) {
        e.preventDefault();
        var dt    = e.dataTransfer;
        var files = dt.files;
        for (var i=0; i<files.length; i++) {
          var file = files[i];
          var timestamp = "";
          var key = file.name.split(" ").join("");
          var reader = new FileReader();
          reader.addEventListener('loadend', function(e) {
            fetch(apiBaseURL+"/getURL", {
              method: "POST",
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                name: file.name,
                type: file.type
              })
            })
            .then(function(response) {
              return response.json();
            })
            .then(function(json) {
              timestamp = "" + json.timestamp;
              key = timestamp + "_" + key;
              console.log(timestamp);
              return fetch(json.uploadURL, {
                method: "PUT",
                body: new Blob([reader.result], {key: json.key, type: file.type})
              })
            })
            .then(function() {
              var audioNode = document.createElement('div');
              var url = window.location.origin + window.location.pathname + "?AccessKey=" + key;
              audioNode.innerHTML = '<a href="'+ url +'">'+ key +'</a>';
              var valArray = [url, key];
              audioNode.value = valArray;
              list.appendChild(audioNode);
            });
          });
          reader.readAsArrayBuffer(file);
        }
        return false;
      }

      // Handle when the user enters a key into the form
      function handleKey() {
        
        // fetch(apiBaseURL+"/getFileURL", {
        //   method: "POST",
        //   headers: {
        //     'Content-Type': 'application/json',
        //   },
        //   body: JSON.stringify({
        //     key: accessKey,
        //   })
        // })
        // .then(function(response) {
        //   return response.json();
        // })
        // .then(function(json) {
        //   if (json.url != "undefined")
        //     document.getElementById('audioURL').src = json.url;
        // });
        var url = "https://s3.amazonaws.com/audemos-dev-demos/" + accessKey;
        document.getElementById('audioURL').src = url;
        document.getElementById('audioFile').innerHTML = url.split("_", 2)[1];

        var audioNode = document.createElement('div');
        url = window.location.origin + window.location.pathname + "?AccessKey=" + accessKey;
        audioNode.innerHTML = '<a href="'+ url + '">'+ accessKey +'</a>';
        var valArray = [url, accessKey];
        audioNode.value = valArray;
        list.appendChild(audioNode);
      }

      // Copy the latest uploaded url
      function copyURL() {
        if (list.childElementCount > 1) {
          var text = list.children[1].value[0];
          console.log(text);
          navigator.clipboard.writeText(text).then(function() {
            console.log('Async: Successfully copied URL');
          }, function(err) {
            console.error('Async: Could not copy URL');
          });
        }
      }

      // Copy the latest uploaded key
      function copyKey() {
        if (list.childElementCount > 1) {
          var text = list.children[1].value[1];
          console.log(text);
          navigator.clipboard.writeText(text).then(function() {
            console.log('Async: Successfully copied URL');
          }, function(err) {
            console.error('Async: Could not copy URL');
          });
        }
      }

      // Tells the browser that we *can* drop on this target
      drop.addEventListener('dragenter', cancel);
      drop.addEventListener('dragover', cancel);
      drop.addEventListener('drop', handleDrop);

      console.log(accessKey);
      if (accessKey != null) {
        handleKey();
      } else {
        document.getElementById('audioFile').innerHTML = "None";
      }
    </script>

  </body>
</html>
